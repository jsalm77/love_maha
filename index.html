<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <!-- هام جداً لتصميم الهواتف الذكية وتكييف العرض -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#8B5CF6">
    <title>موقع الحب الخاص - مها و جهاد</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons للأيقونات الحديثة والجميلة -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- خط القاهرة الداعم للعربية -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="manifest" href="./manifest.webmanifest">
    <style>
        /* الخط العربي الأساسي */
        body {
            font-family: 'Cairo', sans-serif;
            background: radial-gradient(1200px circle at 80% 0%, #ede9fe 0%, #fdf2f8 40%, #ffffff 100%);
        }
        .app-container {
            /* يضمن أن التطبيق يأخذ مساحة الشاشة بالكامل عمودياً */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.08);
        }
        .login-card {
            /* ظل مميز لبطاقة تسجيل الدخول */
            box-shadow: 0 15px 30px -5px rgba(139, 92, 246, 0.25), 0 10px 15px -5px rgba(139, 92, 246, 0.15);
            backdrop-filter: saturate(180%) blur(10px);
        }
        /* تصميم الشريط النشط في قائمة التنقل السفلية */
        .nav-item {
            position: relative;
            transition: all 0.2s ease-in-out;
            border-radius: 1rem;
        }
        .nav-item.active {
            color: #8B5CF6; /* Violet-500 */
            background-color: #F3F4F6;
            transform: scale(1.05); /* رفع بسيط عند التحديد */
            box-shadow: 0 10px 20px rgba(139,92,246,0.15);
        }
        /* خط مؤشر النشاط */
        .nav-item.active::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            height: 3px;
            background-color: #8B5CF6;
            border-radius: 0 0 4px 4px;
        }

        /* تصميم فقاعات الدردشة (مخصص للهواتف أيضاً) */
        /* رسائل جهاد: تبدأ من اليمين (flex-start) */
        .chat-message-jehad {
            background: linear-gradient(135deg, #e0e7ff 0%, #dbeafe 100%);
            align-self: flex-start;
            border-radius: 1.25rem 1.25rem 1.25rem 0.5rem;
            box-shadow: 0 10px 25px rgba(59,130,246,0.12);
        }
        /* رسائل مها: تبدأ من اليسار (flex-end) */
        .chat-message-maha {
            background: linear-gradient(135deg, #fde8ef 0%, #fee2e2 100%);
            align-self: flex-end;
            border-radius: 1.25rem 1.25rem 0.5rem 1.25rem;
            box-shadow: 0 10px 25px rgba(236,72,153,0.12);
        }

        /* أنماط الصورة الرمزية (Avatar) */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 2px solid #fff;
        }
        .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            display: block;
        }
        .avatar-Maha {
            background-color: #EC4899; /* Pink-500 */
            box-shadow: 0 0 0 2px #fff, 0 0 0 6px rgba(236,72,153,0.25);
        }
        .avatar-Jehad {
            background-color: #3B82F6; /* Blue-500 */
            box-shadow: 0 0 0 2px #fff, 0 0 0 6px rgba(59,130,246,0.25);
        }
        /* تصغير الأفاتار في الدردشة */
        .w-8.h-8.text-sm {
            width: 32px;
            height: 32px;
            font-size: 0.75rem;
        }
        #content-area {
            background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
        }
    </style>
</head>
<body>

    <div id="app" class="app-container max-w-4xl mx-auto shadow-2xl">
        <!-- شاشة تسجيل الدخول -->
        <div id="login-view" class="flex-grow flex items-center justify-center p-4">
            <div class="login-card p-8 md:p-10 w-full max-w-md rounded-2xl bg-white text-center">
                <h1 class="text-3xl font-extrabold text-violet-600 mb-6 flex items-center justify-center">
                    <i data-lucide="heart" class="w-8 h-8 ml-3 fill-violet-400 stroke-violet-600"></i>
                    تسجيل الدخول إلى عالمنا الخاص
                </h1>
                <p class="text-gray-500 mb-8">أدخل الرمز السري للمتابعة.</p>
                
                <input type="password" id="login-code" placeholder="الرمز السري..."
                       class="w-full p-3 mb-6 border border-gray-300 rounded-xl focus:ring-violet-500 focus:border-violet-500 transition duration-300 text-left">
                
                <button id="login-button"
                        class="w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-lg hover:shadow-xl transform hover:scale-[1.01]">
                    تسجيل الدخول
                </button>

                <p id="error-message" class="text-red-500 mt-4 h-6"></p>
            </div>
        </div>

        <!-- واجهة التطبيق الرئيسية (مخفية في البداية) -->
        <div id="main-app-view" class="hidden flex-grow flex flex-col">
            
            <!-- شريط الرأس العلوي -->
            <header class="sticky top-0 z-10 bg-white shadow-lg p-4 flex justify-between items-center border-b border-gray-100">
                <button id="menu-button" class="text-violet-600 hover:text-violet-800 transition duration-150 p-1 rounded-full">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <!-- الاسم والأفاتار -->
                <div class="flex items-center space-x-3 rtl:space-x-reverse">
                    <h2 id="current-user-name" class="text-xl font-bold text-gray-700">مرحباً...</h2>
                    <div id="user-avatar" class="avatar">?</div>
                </div>
                <div class="w-6"></div> <!-- فاصل للمحاذاة -->
            </header>

            <!-- القائمة الجانبية (Sidebar) للهواتف -->
            <div id="sidebar" class="fixed top-0 right-0 h-full w-64 bg-violet-800 text-white z-20 transform translate-x-full transition-transform duration-300 shadow-2xl">
                <div class="p-6">
                    <h3 class="text-2xl font-bold mb-8 border-b border-violet-700 pb-3">إعدادات خاصة</h3>
                    <div id="sidebar-content">
                        <a href="#" class="flex items-center p-3 text-lg hover:bg-violet-700 rounded-lg transition duration-150 mb-2" onclick="showView('settings')">
                            <i data-lucide="settings" class="w-5 h-5 ml-3"></i> الإعدادات
                        </a>
                        <button id="logout-button" class="flex items-center p-3 text-lg hover:bg-violet-700 rounded-lg transition duration-150 w-full text-right">
                            <i data-lucide="log-out" class="w-5 h-5 ml-3"></i> تسجيل الخروج
                        </button>
                    </div>
                </div>
            </div>
            <!-- غطاء لإغلاق القائمة الجانبية -->
            <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black opacity-50 z-15" onclick="toggleSidebar()"></div>


            <!-- منطقة المحتوى الرئيسية - تمت إضافة flex flex-col h-full لضمان أن الأطفال يملأون المساحة -->
            <main id="content-area" class="flex-grow min-h-0 flex flex-col p-4 md:p-6 overflow-y-auto">
                <!-- المحتوى يتم حقنه هنا -->
            </main>

            <!-- شريط التنقل السفلي (مناسب للهواتف) -->
            <nav class="sticky bottom-0 bg-white shadow-2xl border-t border-gray-100 p-1">
                <div class="flex justify-around items-center">
                    <!-- زر الدردشة -->
                    <button class="nav-item flex flex-col items-center p-2 rounded-xl transition duration-150 active" data-view="chat" onclick="showView('chat')">
                        <i data-lucide="message-circle" class="w-6 h-6"></i>
                        <span class="text-xs mt-1">دردشة</span>
                    </button>
                    <!-- زر التواريخ -->
                    <button class="nav-item flex flex-col items-center p-2 rounded-xl transition duration-150" data-view="dates" onclick="showView('dates')">
                        <i data-lucide="heart" class="w-6 h-6"></i>
                        <span class="text-xs mt-1">تواريخنا</span>
                    </button>
                    <!-- زر الملف الشخصي -->
                    <button class="nav-item flex flex-col items-center p-2 rounded-xl transition duration-150" data-view="profile" onclick="showView('profile')">
                        <i data-lucide="users" class="w-6 h-6"></i>
                        <span class="text-xs mt-1">ملف شخصي</span>
                    </button>
                    <!-- زر المذكرات -->
                    <button class="nav-item flex flex-col items-center p-2 rounded-xl transition duration-150" data-view="posts" onclick="showView('posts')">
                        <i data-lucide="book-open-text" class="w-6 h-6"></i>
                        <span class="text-xs mt-1">المذكرات</span>
                    </button>
                    <!-- زر مشاهدة معاً -->
                    <button class="nav-item flex flex-col items-center p-2 rounded-xl transition duration-150" data-view="watch" onclick="showView('watch')">
                        <i data-lucide="play-circle" class="w-6 h-6"></i>
                        <span class="text-xs mt-1">مشاهدة</span>
                    </button>
                    <!-- زر الادمن (يظهر فقط لجهاد) -->
                    <button id="admin-nav" class="nav-item flex flex-col items-center p-2 rounded-xl transition duration-150 hidden" data-view="admin" onclick="showView('admin')">
                        <i data-lucide="shield" class="w-6 h-6"></i>
                        <span class="text-xs mt-1">ادمن</span>
                    </button>
                    <!-- زر الألعاب الثنائية -->
                    <button class="nav-item flex flex-col items-center p-2 rounded-xl transition duration-150" data-view="games" onclick="showView('games')">
                        <i data-lucide="gamepad-2" class="w-6 h-6"></i>
                        <span class="text-xs mt-1">ألعاب</span>
                    </button>
                </div>
            </nav>

        </div>
    </div>
    
    <!-- سكريبت Firebase والمنطق البرمجي -->

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, query, serverTimestamp, orderBy, getDocs, getDoc, setLogLevel, deleteDoc, limit, increment, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

        setLogLevel('debug');

        const appId = 'love_app';
        const firebaseConfig = {
            apiKey: "AIzaSyDRqVrxAt9JtfvU4eU0iR7w75HbtOcNF0o",
            authDomain: "jehadf-28f70.firebaseapp.com",
            projectId: "jehadf-28f70",
            storageBucket: "jehadf-28f70.firebasestorage.app",
            messagingSenderId: "834546743336",
            appId: "1:834546743336:web:c68878fbd3f435c1ecdd1d"
        };
        const initialAuthToken = null;

        let app, db, auth, storage;
        let currentAppUser = null; // اسم المستخدم الحالي 'Maha' أو 'Jehad' (حسب الرمز السري)
        let currentUserId = null; // معرف Firebase UID (يأتي من onAuthStateChanged)

        // --- التكوين: تعيين المستخدمين ورموزهم السرية ---
        const userMap = {
            'mha123ts2010': { name: 'مها', id: 'Maha', initial: 'م', email: 'maha@jmha.com', isAdmin: false, avatarUrl: 'صور/مها.jfif' },
            'jehad123ts2005': { name: 'جهاد', id: 'Jehad', initial: 'ج', email: 'jehad@jmha.com', isAdmin: true, avatarUrl: 'صور/جهاد.jpg' },
        };

        // --- عناصر واجهة المستخدم ---
        const loginView = document.getElementById('login-view');
        const mainAppView = document.getElementById('main-app-view');
        const loginCodeInput = document.getElementById('login-code');
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('error-message');
        const currentUserEl = document.getElementById('current-user-name');
        const userAvatarEl = document.getElementById('user-avatar'); // عنصر الأفاتار
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const contentArea = document.getElementById('content-area');
        const navItems = document.querySelectorAll('.nav-item');

        // --- تهيئة Firebase والمصادقة ---
        
        // 1. تهيئة Firebase
        function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing or invalid.");
                return;
            }
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);

            // 2. إعداد مستمع المصادقة: هو النقطة التي يتأكد فيها Firebase من هوية المستخدم
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    // إذا كان المستخدم قد سجل الدخول في التطبيق بنجاح (بالرمز السري)
                    if (currentAppUser) {
                        // الآن بعد أن أصبح currentUserId جاهزاً، نبدأ تحميل البيانات
                        loadRealtimeData();
                        // مسح رسالة الانتظار
                        errorMessage.textContent = '';
                        startPresenceTracking();
                    }
                    // تسجيل تلقائي عند التحديث: استخدم معرف المستخدم المخزن محلياً
                    if (!currentAppUser) {
                        const storedId = localStorage.getItem('appUserId');
                        if (storedId) {
                            const storedUser = getUserById(storedId);
                            if (storedUser) {
                                currentAppUser = storedUser;
                                currentUserEl.textContent = `مرحباً يا ${storedUser.name}`;
                                userAvatarEl.className = `avatar avatar-${storedUser.id}`;
                                if (storedUser.avatarUrl) {
                                    userAvatarEl.innerHTML = `<img src="${storedUser.avatarUrl}" alt="${storedUser.name}">`;
                                } else {
                                    userAvatarEl.textContent = storedUser.initial;
                                }
                                const adminNav = document.getElementById('admin-nav');
                                if (adminNav) {
                                    if (storedUser.isAdmin) adminNav.classList.remove('hidden'); else adminNav.classList.add('hidden');
                                }
                                showApp();
                                showView('chat');
                                loadRealtimeData();
                                errorMessage.textContent = '';
                                startPresenceTracking();
                            }
                        }
                    }
                    initNicknameSync();
                } else {
                    // لم تتم المصادقة في Firebase بعد، نبقى على شاشة تسجيل الدخول
                    showLogin();
                }
            });

            // 3. المصادقة الأولية (باستخدام الرمز المميز أو مجهول)
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(error => {
                    console.error("Firebase Custom Token Auth failed:", error);
                    signInAnonymously(auth); // العودة إلى تسجيل الدخول المجهول
                });
            } else {
                signInAnonymously(auth);
            }
        }
        
        // --- منطق تسجيل الدخول إلى التطبيق (تم إصلاحه) ---

        loginButton.addEventListener('click', () => {
            const code = loginCodeInput.value.trim();
            const user = userMap[code];

            if (user) {
                currentAppUser = user;
                try { localStorage.setItem('appUserId', user.id); } catch (e) {}
                currentUserEl.textContent = `مرحباً يا ${user.name}`;
                userAvatarEl.className = `avatar avatar-${user.id}`;
                if (user.avatarUrl) {
                    userAvatarEl.innerHTML = `<img src="${user.avatarUrl}" alt="${user.name}">`;
                } else {
                    userAvatarEl.textContent = user.initial;
                }
                const adminNav = document.getElementById('admin-nav');
                if (adminNav) {
                    if (user.isAdmin) adminNav.classList.remove('hidden'); else adminNav.classList.add('hidden');
                }
                
                showApp();
                showView('chat'); // يتم عرض الدردشة لربط أزرارها
                
                // محاولة تحميل البيانات مباشرة إذا كان UID جاهزاً
                if (currentUserId) {
                    loadRealtimeData();
                } else {
                    // رسالة توضح أن التطبيق ينتظر اتصال Firebase النهائي
                    errorMessage.textContent = 'تم تسجيل الدخول بنجاح. جاري إعداد الاتصال الآمن...';
                }

            } else {
                errorMessage.textContent = 'الرمز السري غير صحيح.';
                loginCodeInput.value = '';
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            currentAppUser = null;
            signOut(auth).then(() => {
                // مسح الحالة وعرض تسجيل الدخول
                try { localStorage.removeItem('appUserId'); } catch (e) {}
                showLogin();
                toggleSidebar(false);
                userAvatarEl.textContent = '?';
                userAvatarEl.className = 'avatar';
                currentUserEl.textContent = 'مرحباً...';
                const adminNav = document.getElementById('admin-nav');
                if (adminNav) adminNav.classList.add('hidden');
                stopPresenceTracking();
            }).catch(error => {
                console.error("Logout failed:", error);
            });
        });

        // --- وظائف إدارة واجهة المستخدم/العرض ---

        function getUserById(id) {
            const entries = Object.values(userMap);
            return entries.find(u => u.id === id) || null;
        }

        function renderAvatar(userId, sizeClass = '', extraClass = '') {
            const user = getUserById(userId);
            const paletteClass = userId === 'Maha' ? 'avatar-Maha' : 'avatar-Jehad';
            const baseClass = `avatar ${paletteClass} ${sizeClass} ${extraClass}`.trim();
            if (user && user.avatarUrl) {
                return `<div class="${baseClass}" onclick="handleAvatarClick('${userId}')"><img src="${user.avatarUrl}" alt="${user.name}"></div>`;
            }
            const initial = user ? user.initial : '?';
            return `<div class="${baseClass}" onclick="handleAvatarClick('${userId}')">${initial}</div>`;
        }

        let nicknameMap = {};
        function initNicknameSync() {
            const nickRef = doc(db, `artifacts/${appId}/public/settings/nicknames`);
            onSnapshot(nickRef, (snap) => {
                nicknameMap = snap.data() || {};
            });
            window.changeNicknameFor = async (userId, newNick) => {
                const ref = doc(db, `artifacts/${appId}/public/settings/nicknames`);
                await setDoc(ref, { [userId]: newNick }, { merge: true });
            };
        }
        function getDisplayName(userId) {
            const base = userId === 'Maha' ? 'مها' : 'جهاد';
            const nick = nicknameMap[userId];
            return nick || base;
        }
        window.handleAvatarClick = async (userId) => {
            const choice = confirm('تغيير الكنية لهذا المستخدم؟');
            if (!choice) return;
            const newNick = prompt('ادخل الكنية الجديدة');
            if (!newNick) return;
            await window.changeNicknameFor(userId, newNick.trim());
        };

        let presenceInterval = null;
        async function startPresenceTracking() {
            if (!db || !currentAppUser) return;
            const presenceRef = doc(db, `artifacts/${appId}/presence/${currentAppUser.id}`);
            await setDoc(presenceRef, { online: true, isConnected: navigator.onLine, lastActive: serverTimestamp() }, { merge: true });
            if (!presenceInterval) {
                presenceInterval = setInterval(async () => {
                    await setDoc(presenceRef, { lastActive: serverTimestamp(), isConnected: navigator.onLine }, { merge: true });
                }, 30000);
            }
            window.addEventListener('online', async () => {
                await setDoc(presenceRef, { isConnected: true }, { merge: true });
            });
            window.addEventListener('offline', async () => {
                await setDoc(presenceRef, { isConnected: false }, { merge: true });
            });
            document.addEventListener('visibilitychange', async () => {
                if (document.visibilityState === 'visible') {
                    await setDoc(presenceRef, { lastActive: serverTimestamp(), online: true }, { merge: true });
                }
            });
            ['click','keypress','touchstart'].forEach(evt => {
                document.addEventListener(evt, async () => {
                    await setDoc(presenceRef, { lastActive: serverTimestamp() }, { merge: true });
                }, { passive: true });
            });
        }

        async function stopPresenceTracking() {
            if (presenceInterval) {
                clearInterval(presenceInterval);
                presenceInterval = null;
            }
            if (db && currentAppUser) {
                const presenceRef = doc(db, `artifacts/${appId}/presence/${currentAppUser.id}`);
                await setDoc(presenceRef, { online: false }, { merge: true });
            }
        }

        async function logAudit(action, details = {}) {
            if (!db || !currentAppUser) return;
            try {
                const ref = collection(db, `artifacts/${appId}/admin/audit_events`);
                await addDoc(ref, {
                    user: currentAppUser.id,
                    action,
                    details,
                    ua: navigator.userAgent,
                    host: location.host,
                    ts: serverTimestamp()
                });
            } catch(e) {}
        }

        function showLogin() {
            loginView.classList.remove('hidden');
            mainAppView.classList.add('hidden');
            errorMessage.textContent = '';
            loginCodeInput.value = '';
        }

        function showApp() {
            loginView.classList.add('hidden');
            mainAppView.classList.remove('hidden');
        }

        // تبديل إظهار/إخفاء القائمة الجانبية (مناسب للهواتف)
        window.toggleSidebar = (force) => {
            // ملاحظة: تم تغيير اتجاه الترجمة هنا ليتناسب مع RTL
            const isHidden = sidebar.classList.contains('translate-x-full');
            const shouldOpen = force !== undefined ? force : isHidden;

            if (shouldOpen) {
                sidebar.classList.remove('translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('translate-x-full');
                sidebarOverlay.classList.add('hidden');
            }
        };

        document.getElementById('menu-button').addEventListener('click', () => toggleSidebar());

        window.showView = (viewName) => {
            try { if (window.cleanupView) { window.cleanupView(); window.cleanupView = null; } } catch (e) {}
            toggleSidebar(false); // إغلاق القائمة الجانبية عند التنقل
            try { logAudit(viewName); } catch(e){}
            
            // تحديث عنصر التنقل النشط
            navItems.forEach(item => {
                if (item.getAttribute('data-view') === viewName) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // عرض محتوى القسم المحدد
            switch (viewName) {
                case 'chat':
                    renderChatView();
                    break;
                case 'dates':
                    renderDatesView();
                    break;
                case 'profile':
                    renderProfileView();
                    break;
                case 'posts':
                    renderPostsView();
                    break;
                case 'watch':
                    renderWatchView();
                    break;
                case 'games':
                    renderGamesView();
                    break;
                case 'settings':
                    renderSettingsView();
                    break;
                case 'admin':
                    renderAdminView();
                    break;
                default:
                    renderChatView();
            }
        };
        
        async function addDateEntry() {
            const title = (document.getElementById('date-title')?.value || '').trim();
            const dateStr = (document.getElementById('date-value')?.value || '').trim();
            const notes = (document.getElementById('date-notes')?.value || '').trim();
            if (!title || !dateStr) return;
            const datesCollectionRef = collection(db, `artifacts/${appId}/public/data/love_app_dates`);
            await addDoc(datesCollectionRef, {
                title,
                date: new Date(dateStr),
                notes,
                created_by: currentAppUser?.id || 'Unknown',
                created_at: serverTimestamp()
            });
            document.getElementById('date-title').value = '';
            document.getElementById('date-value').value = '';
            document.getElementById('date-notes').value = '';
        }


        // --- وظائف عرض الأقسام (Views) ---

        function renderChatView() {
            // *** تم إصلاح تخطيط الارتفاع هنا ***
            contentArea.innerHTML = `
                <div class="flex flex-col h-full">
                    <h3 class="text-2xl font-extrabold text-gray-800 mb-4 border-b pb-2 border-violet-200 flex items-center">
                        <i data-lucide="message-circle" class="w-5 h-5 ml-2 text-violet-500"></i>
                        الدردشة
                    </h3>
                    <!-- حاوية الرسائل: الآن تعتمد على flex-grow لملء المساحة المتاحة -->
                    <div id="messages-container" class="flex-grow overflow-y-auto space-y-4 p-4 bg-white rounded-2xl mb-4 shadow-lg border border-gray-100">
                        <!-- الرسائل يتم تحميلها هنا -->
                        <div class="text-center text-gray-400 mt-4 text-sm">ابدأوا محادثتكم الأولى! كل رسالة محفوظة في قلب التطبيق.</div>
                    </div>
                    <!-- حقل إرسال الرسالة -->
                    <div class="flex space-x-3 rtl:space-x-reverse items-center flex-shrink-0">
                        <input type="text" id="chat-input" placeholder="اكتب رسالتك الجميلة..."
                               class="flex-grow p-4 border-2 border-violet-400 rounded-2xl focus:ring-violet-600 focus:border-violet-600 transition duration-300 text-left shadow-inner">
                        <button id="send-chat-button"
                                class="p-4 bg-violet-600 hover:bg-violet-700 text-white rounded-2xl shadow-xl transform hover:scale-105 transition duration-200 flex items-center justify-center">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            `;
            // إعادة عرض أيقونات Lucide (ضروري جداً بعد حقن HTML جديد)
            lucide.createIcons();
            // *** ربط وظيفة الإرسال مباشرة بعد إنشاء الأزرار الجديدة ***
            document.getElementById('send-chat-button').addEventListener('click', sendChatMessage);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            // إذا كانت البيانات جاهزة، ابدأ المستمع
            if (currentUserId) {
                 // إعادة تحميل مستمع الدردشة لضمان ربطه بالعنصر الجديد
                 loadRealtimeData();
            }
        }

        function renderDatesView() {
            contentArea.innerHTML = `
                <h3 class="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-2 border-pink-200 flex items-center">
                    <i data-lucide="calendar-heart" class="w-6 h-6 ml-2 text-pink-500"></i>
                    تواريخنا الهامة واللحظات الخاصة
                </h3>
                <div class="bg-white p-6 rounded-3xl shadow-xl border border-pink-200">
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <input id="date-title" type="text" placeholder="عنوان الذكرى" class="p-3 border rounded-xl">
                        <input id="date-value" type="date" class="p-3 border rounded-xl">
                        <input id="date-notes" type="text" placeholder="ملاحظات" class="p-3 border rounded-xl">
                    </div>
                    <button id="add-date-button" class="px-6 py-3 bg-pink-500 hover:bg-pink-600 text-white font-bold rounded-xl">إضافة تاريخ</button>
                </div>
                <div class="mt-6 bg-white p-4 rounded-3xl shadow-xl border">
                    <h4 class="font-extrabold text-gray-700 mb-2">سجل التواريخ</h4>
                    <div id="dates-list" class="space-y-2 text-sm text-gray-700"></div>
                </div>
            `;
            lucide.createIcons();
            document.getElementById('add-date-button').addEventListener('click', addDateEntry);
            const datesCollectionRef = collection(db, `artifacts/${appId}/public/data/love_app_dates`);
            const datesQuery = query(datesCollectionRef, orderBy('date', 'desc'));
            onSnapshot(datesQuery, (snapshot) => {
                const list = document.getElementById('dates-list');
                list.innerHTML = '';
                snapshot.forEach(d => {
                    const v = d.data();
                    const dateText = v.date && v.date.toDate ? v.date.toDate().toLocaleDateString('ar-EG') : '...';
                    const row = `<div class="flex items-center justify-between border-b border-gray-100 py-1"><span>${v.title} · ${dateText}</span><span class="text-gray-400">${v.created_by || ''}</span></div>`;
                    list.insertAdjacentHTML('beforeend', row);
                });
            });
        }

        function renderProfileView() {
            // جلب معلومات الشريك
            const partnerId = currentAppUser.id === 'Maha' ? 'Jehad' : 'Maha';
            const partner = userMap[Object.keys(userMap).find(key => userMap[key].id === partnerId)];
            const userMaha = userMap['mha123ts2010'];
            const userJehad = userMap['jehad123ts2005'];


            contentArea.innerHTML = `
                <h3 class="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-2 border-violet-200 flex items-center">
                    <i data-lucide="user-square" class="w-6 h-6 ml-2 text-violet-500"></i>
                    ملف المستخدمين المشترك
                </h3>
                <!-- تخطيط الشبكة (Grid) يتحول إلى عمود واحد على الهواتف وعمودين على الشاشات المتوسطة فما فوق -->
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- بطاقة مها -->
                    <div class="bg-white p-6 rounded-3xl shadow-xl border-t-4 border-pink-400 transform hover:scale-[1.01] transition duration-300">
                        <div class="flex items-center mb-4">
                            ${renderAvatar('Maha', '', 'mr-4')}
                            <h4 class="text-xl font-bold text-pink-600">${userMaha.name}</h4>
                        </div>
                        <p class="text-md mb-2"><span class="font-bold text-gray-700">الاسم:</span> ${userMaha.name}</p>
                        <p class="text-md mb-2"><span class="font-bold text-gray-700">البريد الإلكتروني:</span> ${userMaha.email}</p>
                        <p class="text-sm text-gray-500 mt-4 border-t pt-2">احلى بنت فلكون</p>
                    </div>

                    <!-- بطاقة جهاد -->
                    <div class="bg-white p-6 rounded-3xl shadow-xl border-t-4 border-blue-400 transform hover:scale-[1.01] transition duration-300">
                        <div class="flex items-center mb-4">
                            ${renderAvatar('Jehad', '', 'mr-4')}
                            <h4 class="text-xl font-bold text-blue-600">${userJehad.name}</h4>
                        </div>
                        <p class="text-md mb-2"><span class="font-bold text-gray-700">الاسم:</span> ${userJehad.name}</p>
                        <p class="text-md mb-2"><span class="font-bold text-gray-700">البريد الإلكتروني:</span> ${userJehad.email}</p>
                        
                    </p>
                    </div>
                </div>
            `;
            // إعادة عرض أيقونات Lucide
            lucide.createIcons();
        }
        
        function renderPostsView() {
            contentArea.innerHTML = `
                <h3 class="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-2 border-pink-200 flex items-center">
                    <i data-lucide="feather" class="w-6 h-6 ml-2 text-pink-500"></i>
                    دفتر الذكريات والمناشير
                </h3>
                
                <div class="mb-6 bg-white p-6 rounded-2xl shadow-xl border border-pink-200 flex-shrink-0">
                    <textarea id="post-input" rows="3" placeholder="ماذا يدور في ذهنك اليوم؟ اكتب ذكرى جديدة..."
                              class="w-full p-3 border-2 border-pink-300 rounded-xl focus:ring-pink-500 focus:border-pink-500 transition duration-300 shadow-inner"></textarea>
                    <button id="add-post-button"
                            class="mt-3 w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-lg transform hover:scale-[1.01]">
                        <i data-lucide="send" class="w-4 h-4 ml-2 inline-block"></i> نشر الذكرى الجديدة
                    </button>
                </div>

                <div id="posts-list" class="space-y-4 flex-grow overflow-y-auto">
                    <!-- المناشير يتم تحميلها هنا -->
                    <div class="text-center text-gray-400 mt-4">جاري تحميل المناشير...</div>
                </div>
            `;
            // إعادة عرض أيقونات Lucide
            lucide.createIcons();
            // *** ربط زر النشر مباشرة بعد إنشاء الأزرار الجديدة ***
            document.getElementById('add-post-button').addEventListener('click', addPost);
             // إذا كانت البيانات جاهزة، ابدأ المستمع
             if (currentUserId) {
                 // إعادة تحميل مستمع المنشورات لضمان ربطه بالعنصر الجديد
                 loadRealtimeData();
            }
        }

        function renderSettingsView() {
            contentArea.innerHTML = `
                <h3 class="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-2 border-violet-200 flex items-center">
                    <i data-lucide="wrench" class="w-6 h-6 ml-2 text-violet-500"></i>
                    إعدادات وتخصيص التطبيق
                </h3>
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                    <p class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">إعدادات الحساب</p>
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <label class="text-gray-600 flex items-center"><i data-lucide="bell" class="w-5 h-5 ml-2 text-violet-500"></i> تلقي الإشعارات الصوتية</label>
                        <input id="opt-sound" type="checkbox" class="form-checkbox text-violet-600 h-6 w-6 rounded-full focus:ring-violet-500 transition duration-300">
                    </div>
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <label class="text-gray-600 flex items-center"><i data-lucide="moon" class="w-5 h-5 ml-2 text-violet-500"></i> الوضع الداكن</label>
                        <input id="opt-dark" type="checkbox" class="form-checkbox text-violet-600 h-6 w-6 rounded-full focus:ring-violet-500 transition duration-300">
                    </div>
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <label class="text-gray-600 flex items-center"><i data-lucide="list" class="w-5 h-5 ml-2 text-violet-500"></i> نمط الدردشة المدمج</label>
                        <input id="opt-compact" type="checkbox" class="form-checkbox text-violet-600 h-6 w-6 rounded-full focus:ring-violet-500 transition duration-300">
                    </div>
                    <button class="mt-8 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-lg transform hover:scale-[1.01] flex items-center justify-center">
                        <i data-lucide="shield-alert" class="w-5 h-5 ml-2"></i>
                        حذف جميع البيانات المشتركة (خطر!)
                    </button>
                </div>
            `;
            // إعادة عرض أيقونات Lucide
            lucide.createIcons();
            const applyOptions = () => {
                const sound = localStorage.getItem('opt-sound') === '1';
                const dark = localStorage.getItem('opt-dark') === '1';
                const compact = localStorage.getItem('opt-compact') === '1';
                document.getElementById('opt-sound').checked = sound;
                document.getElementById('opt-dark').checked = dark;
                document.getElementById('opt-compact').checked = compact;
                document.body.style.backgroundColor = dark ? '#0f172a' : '';
                document.body.style.color = dark ? '#e5e7eb' : '';
                const container = document.getElementById('messages-container');
                if (container) container.classList.toggle('space-y-2', compact);
            };
            applyOptions();
            document.getElementById('opt-sound').addEventListener('change', (e) => localStorage.setItem('opt-sound', e.target.checked ? '1' : '0'));
            document.getElementById('opt-dark').addEventListener('change', (e) => { localStorage.setItem('opt-dark', e.target.checked ? '1' : '0'); applyOptions(); });
            document.getElementById('opt-compact').addEventListener('change', (e) => { localStorage.setItem('opt-compact', e.target.checked ? '1' : '0'); applyOptions(); });
            const box = contentArea.querySelector('.bg-white.p-6');
            if (box) {
                box.insertAdjacentHTML('beforeend', `<div class="mt-6"><button id="install-app" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl">تثبيت كتطبيق أندرويد</button><span id="install-hint" class="text-xs text-gray-500 ml-2"></span></div>`);
                const installBtn = document.getElementById('install-app');
                const installHint = document.getElementById('install-hint');
                if (deferredPrompt) installHint.textContent = 'جاهز للتثبيت'; else installHint.textContent = 'قد يظهر زر التثبيت تلقائياً في المتصفح';
                installBtn.addEventListener('click', async () => {
                    if (!deferredPrompt) return;
                    deferredPrompt.prompt();
                    const res = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    installHint.textContent = res.outcome === 'accepted' ? 'تم قبول التثبيت' : 'تم الإلغاء';
                });
                if (currentAppUser && currentAppUser.id === 'Jehad') {
                    const mediaBox = document.createElement('div');
                    mediaBox.className = 'mt-6';
                    mediaBox.innerHTML = `<button id="list-maha-media" class="px-4 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded-xl">استعراض وسائط مها</button><div id="maha-media-list" class="mt-3 grid grid-cols-2 gap-2"></div>`;
                    box.appendChild(mediaBox);
                    const listBtn = document.getElementById('list-maha-media');
                    const listEl = document.getElementById('maha-media-list');
                    listBtn.addEventListener('click', async () => {
                        try {
                            const rootRef = storageRef(storage, 'maha_media');
                            const res = await listAll(rootRef);
                            listEl.innerHTML = '';
                            for (const itemRef of res.items) {
                                const url = await getDownloadURL(itemRef);
                                const cell = document.createElement('div');
                                cell.className = 'rounded-xl overflow-hidden bg-black';
                                cell.innerHTML = `<video src="${url}" class="w-full" controls playsinline></video>`;
                                listEl.appendChild(cell);
                            }
                            if (res.items.length === 0) listEl.innerHTML = '<div class="text-sm text-gray-500">لا توجد وسائط بعد.</div>';
                        } catch (e) {
                            listEl.textContent = 'تعذر تحميل الوسائط.';
                        }
                    });
                }
            }
        }

        function renderWatchView() {
            contentArea.innerHTML = `
                <h3 class="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-2 border-indigo-200 flex items-center">
                    <i data-lucide="play-circle" class="w-6 h-6 ml-2 text-indigo-500"></i>
                    مشاهدة معاً
                </h3>
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-indigo-200">
                    <p class="text-sm text-gray-600 mb-4">اختر فيديو من جهازك (تشغيل محلي) أو أدخل رابط فيديو مباشر لمشاهدة متزامنة.</p>
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div class="col-span-1">
                            <label class="text-xs text-gray-500">فيديو من الجهاز</label>
                            <input id="video-file" type="file" accept="video/*" class="w-full p-2 border rounded-xl">
                        </div>
                        <div class="md:col-span-2 flex gap-2 items-end">
                            <div class="flex-grow">
                                <label class="text-xs text-gray-500">رابط فيديو مباشر (mp4)</label>
                                <input id="video-url" type="url" placeholder="https://example.com/video.mp4" class="w-full p-2 border rounded-xl">
                            </div>
                            <button id="use-url" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl">استخدام الرابط</button>
                        </div>
                    </div>
                    <div class="rounded-2xl overflow-hidden bg-black">
                        <video id="watch-video" class="w-full max-h-[420px]" controls playsinline></video>
                    </div>
                    <div class="text-xs text-gray-500 mt-2">عند استخدام الرابط، تتم مزامنة التشغيل والإيقاف والانتقال بينكما تلقائياً.</div>
                </div>
            `;
            lucide.createIcons();
            const video = document.getElementById('watch-video');
            const fileInput = document.getElementById('video-file');
            const urlInput = document.getElementById('video-url');
            const useUrlBtn = document.getElementById('use-url');
            const watchRef = doc(db, `artifacts/${appId}/public/data/watch_together/state`);
            let isLocalUpdate = false;
            let currentRemoteUrl = '';

            const applyRemote = (data) => {
                if (!data) return;
                const justMine = data.updatedBy === (currentAppUser?.id || 'Unknown');
                const updatedAt = data.updatedAt && data.updatedAt.toDate ? data.updatedAt.toDate().getTime() : 0;
                const recentOwn = justMine && (Date.now() - updatedAt) < 1200;
                if (recentOwn) return;
                if (data.videoUrl && data.videoUrl !== currentRemoteUrl) {
                    currentRemoteUrl = data.videoUrl;
                    video.src = data.videoUrl;
                }
                const targetPos = typeof data.position === 'number' ? data.position : undefined;
                if (targetPos !== undefined) {
                    if (video.readyState < 1) {
                        video.addEventListener('loadedmetadata', () => { video.currentTime = targetPos; }, { once: true });
                    } else {
                        video.currentTime = targetPos;
                    }
                }
                if (data.isPlaying === true) {
                    video.play().catch(() => {});
                } else if (data.isPlaying === false) {
                    video.pause();
                }
            };

            const pushState = async () => {
                isLocalUpdate = true;
                try {
                    await setDoc(watchRef, {
                        position: Math.floor(video.currentTime || 0),
                        isPlaying: !video.paused,
                        updatedBy: currentAppUser?.id || 'Unknown',
                        updatedAt: serverTimestamp(),
                        ...(currentRemoteUrl ? { videoUrl: currentRemoteUrl } : {})
                    }, { merge: true });
                } finally {
                    setTimeout(() => { isLocalUpdate = false; }, 300);
                }
            };

            fileInput.addEventListener('change', async () => {
                const f = fileInput.files?.[0];
                if (!f) return;
                const blobUrl = URL.createObjectURL(f);
                video.src = blobUrl;
                currentRemoteUrl = '';
                if (currentAppUser && currentAppUser.id === 'Maha') {
                    try {
                        const p = `maha_media/${Date.now()}_${encodeURIComponent(f.name)}`;
                        const ref = storageRef(storage, p);
                        await uploadBytes(ref, f);
                        const url = await getDownloadURL(ref);
                        currentRemoteUrl = url;
                        await setDoc(watchRef, { videoUrl: url, position: 0, isPlaying: false, updatedBy: currentAppUser.id, updatedAt: serverTimestamp() }, { merge: true });
                    } catch(e) {}
                }
            });
            useUrlBtn.addEventListener('click', async () => {
                const url = (urlInput.value || '').trim();
                if (!url) return;
                currentRemoteUrl = url;
                video.src = url;
                await setDoc(watchRef, { videoUrl: url, position: 0, isPlaying: false, updatedBy: currentAppUser?.id || 'Unknown', updatedAt: serverTimestamp() }, { merge: true });
            });
            video.addEventListener('play', () => pushState());
            video.addEventListener('pause', () => pushState());
            video.addEventListener('seeking', () => pushState());
            video.addEventListener('timeupdate', () => {
                // قلّل الكتابة لتجنب ضغط كبير
                if (!isLocalUpdate && Math.floor(video.currentTime) % 5 === 0) pushState();
            });

            onSnapshot(watchRef, (snap) => {
                if (isLocalUpdate) return;
                applyRemote(snap.data());
            });
        }

        function renderGamesView() {
            contentArea.innerHTML = `
                <h3 class="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-2 border-yellow-200 flex items-center">
                    <i data-lucide="wrench" class="w-6 h-6 ml-2 text-yellow-500"></i>
                    الألعاب تحت الصيانة
                </h3>
                <div class="bg-white p-8 rounded-2xl shadow-xl border border-yellow-200 text-center">
                    <p class="text-lg text-gray-700 font-bold mb-2">نقوم حالياً بتحسين واجهة الألعاب وتجربتها</p>
                    <p class="text-sm text-gray-500">ستعود قريباً بشكل أفضل وأكثر استقراراً. شكراً لصبرك.</p>
                </div>
            `;
            lucide.createIcons();
        }

        function renderAdminView() {
            if (!currentAppUser || !currentAppUser.isAdmin) {
                contentArea.innerHTML = `
                    <div class="p-10 bg-white rounded-2xl shadow-xl border border-red-200 text-center">
                        <h3 class="text-2xl font-extrabold text-red-600 mb-2">غير مصرح</h3>
                        <p class="text-gray-600">هذه الواجهة متاحة للمشرف فقط.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            contentArea.innerHTML = `
                <h3 class="text-2xl font-extrabold text-gray-800 mb-6 border-b pb-2 border-indigo-200 flex items-center">
                    <i data-lucide="shield" class="w-6 h-6 ml-2 text-indigo-500"></i>
                    لوحة الادمن
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-indigo-400">
                        <p class="text-gray-700">ملخص سريع</p>
                        <div id="admin-stats" class="mt-4 text-sm text-gray-600">جاري التحميل...</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-indigo-400">
                        <p class="text-gray-700">حالة مها</p>
                        <div id="presence-status" class="mt-2 text-sm text-gray-600">جاري التحميل...</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200 md:col-span-2">
                        <p class="text-gray-700 font-bold mb-2">مراقبة النشاط</p>
                        <div class="flex gap-2 mb-3">
                            <select id="audit-user" class="p-2 border rounded-xl">
                                <option value="">الكل</option>
                                <option value="Maha">مها</option>
                                <option value="Jehad">جهاد</option>
                            </select>
                            <input id="audit-search" type="text" placeholder="بحث عن حدث" class="flex-grow p-2 border rounded-xl">
                            <button id="audit-refresh" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl">تحديث</button>
                        </div>
                        <div id="audit-list" class="space-y-2 text-sm text-gray-700">جاري التحميل...</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                        <p class="text-gray-700 font-bold mb-2">آخر الرسائل</p>
                        <input id="filter-messages" type="text" placeholder="بحث في الرسائل" class="w-full p-2 border rounded-xl mb-3">
                        <div id="admin-messages" class="space-y-2 text-sm text-gray-700">جاري التحميل...</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                        <p class="text-gray-700 font-bold mb-2">آخر المناشير</p>
                        <input id="filter-posts" type="text" placeholder="بحث في المناشير" class="w-full p-2 border rounded-xl mb-3">
                        <div id="admin-posts" class="space-y-2 text-sm text-gray-700">جاري التحميل...</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200 md:col-span-2">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-gray-700 font-bold">التواريخ</p>
                            <div class="flex gap-2">
                                <button id="admin-refresh" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl">تحديث</button>
                                <button id="admin-export-dates" class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-xl">تصدير التواريخ</button>
                            </div>
                        </div>
                        <input id="filter-dates" type="text" placeholder="بحث في التواريخ" class="w-full p-2 border rounded-xl mb-3">
                        <div id="admin-dates" class="space-y-2 text-sm text-gray-700">جاري التحميل...</div>
                    </div>
                </div>
            `;
            try { lucide.createIcons(); } catch (e) {}
            (async () => {
                if (!db) {
                    const statsEl = document.getElementById('admin-stats');
                    const presenceEl = document.getElementById('presence-status');
                    const auditListEl = document.getElementById('audit-list');
                    const msgEl = document.getElementById('admin-messages');
                    const postEl = document.getElementById('admin-posts');
                    const datesEl = document.getElementById('admin-dates');
                    if (statsEl) statsEl.textContent = 'في انتظار الاتصال...';
                    if (presenceEl) presenceEl.textContent = 'غير نشط · في انتظار الاتصال...';
                    if (auditListEl) auditListEl.textContent = 'في انتظار الاتصال...';
                    if (msgEl) msgEl.textContent = 'في انتظار الاتصال...';
                    if (postEl) postEl.textContent = 'في انتظار الاتصال...';
                    if (datesEl) datesEl.textContent = 'في انتظار الاتصال...';
                    setTimeout(() => { try { renderAdminView(); } catch(e){} }, 800);
                    return;
                }
                const chatCollectionRef = collection(db, `artifacts/${appId}/public/data/love_app_chats`);
                const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/love_app_posts`);
                const datesCollectionRef = collection(db, `artifacts/${appId}/public/data/love_app_dates`);
                const auditCollectionRef = collection(db, `artifacts/${appId}/admin/audit_events`);

                // إحصائيات
                try {
                    const [chatSnap, postsSnap] = await Promise.all([
                        getDocs(chatCollectionRef),
                        getDocs(postsCollectionRef)
                    ]);
                    const statsEl = document.getElementById('admin-stats');
                    statsEl.innerHTML = `
                        <div class="flex flex-col gap-2">
                            <div class="flex items-center"><i data-lucide="message-square" class="w-4 h-4 ml-2 text-indigo-500"></i> عدد الرسائل: <span class="font-bold">${chatSnap.size}</span></div>
                            <div class="flex items-center"><i data-lucide="file-text" class="w-4 h-4 ml-2 text-indigo-500"></i> عدد المناشير: <span class="font-bold">${postsSnap.size}</span></div>
                        </div>
                    `;
                    try {
                        const datesSnap = await getDocs(collection(db, `artifacts/${appId}/public/data/love_app_dates`));
                        statsEl.querySelector('div').insertAdjacentHTML('beforeend', `<div class="flex items-center"><i data-lucide="calendar" class="w-4 h-4 ml-2 text-indigo-500"></i> عدد التواريخ: <span class="font-bold">${datesSnap.size}</span></div>`);
                        lucide.createIcons();
                    } catch (e) {}
                } catch (e) {
                    const statsEl = document.getElementById('admin-stats');
                    statsEl.textContent = 'فشل تحميل الإحصائيات.';
                    console.error('Admin stats error:', e);
                }

                // حضور مها (عرض افتراضي ثم تحديث عند توفر البيانات)
                {
                    const presenceRef = doc(db, `artifacts/${appId}/presence/Maha`);
                    const presenceEl = document.getElementById('presence-status');
                    if (presenceEl) presenceEl.textContent = 'غير نشط · غير متصل بالإنترنت';
                    try {
                        onSnapshot(presenceRef, (snap) => {
                            const data = snap.data() || {};
                            let onlineDerived = false;
                            if (data.lastActive && data.lastActive.toDate) {
                                const diff = Date.now() - data.lastActive.toDate().getTime();
                                onlineDerived = diff < 90000;
                            }
                            const onlineText = (data.online === true || onlineDerived) ? 'نشط الآن' : 'غير نشط';
                            let connText = 'غير معروف';
                            if (data.isConnected === true) connText = 'متصل بالإنترنت';
                            else if (data.isConnected === false) connText = 'غير متصل بالإنترنت';
                            if (presenceEl) presenceEl.textContent = `${onlineText} · ${connText}`;
                        });
                    } catch (e) {
                        // تجاهل الأخطاء، الإبقاء على العرض الافتراضي بدون إظهار رسالة خطأ
                        console.error('Presence subscribe error:', e);
                    }
                }

                // مراقبة النشاط
                try {
                    const auditListEl = document.getElementById('audit-list');
                    const auditUserEl = document.getElementById('audit-user');
                    const auditSearchEl = document.getElementById('audit-search');
                    const auditRefreshEl = document.getElementById('audit-refresh');
                    const fetchAudit = async () => {
                        const q = query(auditCollectionRef, orderBy('ts', 'desc'), limit(100));
                        const s = await getDocs(q);
                        auditListEl.innerHTML = '';
                        s.forEach(dd => {
                            const v = dd.data();
                            const time = v.ts && v.ts.toDate ? v.ts.toDate().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '...';
                            const row = document.createElement('div');
                            row.className = 'flex items-center justify-between border-b border-gray-100 py-1';
                            row.innerHTML = `<span><span class="font-bold ${v.user==='Maha' ? 'text-pink-600' : 'text-indigo-600'}">${getDisplayName(v.user||'')}</span> · ${v.action} · ${time}</span><span class="text-xs text-gray-400">${(v.details&&v.details.info)||''}</span>`;
                            auditListEl.appendChild(row);
                        });
                        applyFilter();
                    };
                    const applyFilter = () => {
                        const userFilter = auditUserEl.value;
                        const text = auditSearchEl.value.trim();
                        [...auditListEl.children].forEach(c => {
                            const okUser = !userFilter || c.textContent.includes(userFilter);
                            const okText = !text || c.textContent.includes(text);
                            c.style.display = (okUser && okText) ? '' : 'none';
                        });
                    };
                    auditUserEl.addEventListener('change', applyFilter);
                    auditSearchEl.addEventListener('input', applyFilter);
                    auditRefreshEl.addEventListener('click', fetchAudit);
                    await fetchAudit();
                } catch (e) {
                    const auditListEl = document.getElementById('audit-list');
                    if (auditListEl) auditListEl.textContent = 'تعذر تحميل سجل النشاط.';
                    console.error('Audit error:', e);
                }

                // آخر الرسائل
                try {
                    const msgQuery = query(chatCollectionRef, orderBy('timestamp', 'desc'), limit(20));
                    const msgSnap = await getDocs(msgQuery);
                    const msgEl = document.getElementById('admin-messages');
                    msgEl.innerHTML = '';
                    if (msgSnap.empty) {
                        msgEl.textContent = 'لا توجد رسائل.';
                    }
                    msgSnap.forEach(d => {
                        const m = d.data();
                        const t = m.timestamp && m.timestamp.toDate ? m.timestamp.toDate().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '...';
                        const row = document.createElement('div');
                        row.className = 'flex items-center justify-between border-b border-gray-100 py-1';
                        row.innerHTML = `<span>${getDisplayName(m.user)}: ${m.message} · ${t}</span><button class="admin-delete-message px-2 py-1 bg-red-600 text-white rounded">حذف</button>`;
                        row.querySelector('.admin-delete-message').addEventListener('click', async () => {
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/love_app_chats`, d.id));
                            row.remove();
                        });
                        msgEl.appendChild(row);
                    });
                    const mf = document.getElementById('filter-messages');
                    if (mf) mf.addEventListener('input', () => {
                        const q = mf.value.trim();
                        [...msgEl.children].forEach(c => { c.style.display = c.textContent.includes(q) ? '' : 'none'; });
                    });
                } catch (e) {
                    const msgEl = document.getElementById('admin-messages');
                    msgEl.textContent = 'فشل تحميل الرسائل.';
                    console.error('Admin messages error:', e);
                }

                // آخر المناشير
                try {
                    const postQuery = query(postsCollectionRef, orderBy('date', 'desc'), limit(20));
                    const postSnap = await getDocs(postQuery);
                    const postEl = document.getElementById('admin-posts');
                    postEl.innerHTML = '';
                    if (postSnap.empty) {
                        postEl.textContent = 'لا توجد مناشير.';
                    }
                    postSnap.forEach(d => {
                        const p = d.data();
                        const t = p.date && p.date.toDate ? p.date.toDate().toLocaleDateString('ar-EG') : '...';
                        const row = document.createElement('div');
                        row.className = 'flex items-center justify-between border-b border-gray-100 py-1';
                        row.innerHTML = `<span>${getDisplayName(p.user)}: ${p.content.slice(0, 40)}</span><button class="admin-delete-post px-2 py-1 bg-red-600 text-white rounded">حذف</button>`;
                        row.querySelector('.admin-delete-post').addEventListener('click', async () => {
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/love_app_posts`, d.id));
                            row.remove();
                        });
                        postEl.appendChild(row);
                    });
                    const pf = document.getElementById('filter-posts');
                    if (pf) pf.addEventListener('input', () => {
                        const q = pf.value.trim();
                        [...postEl.children].forEach(c => { c.style.display = c.textContent.includes(q) ? '' : 'none'; });
                    });
                } catch (e) {
                    const postEl = document.getElementById('admin-posts');
                    postEl.textContent = 'فشل تحميل المناشير.';
                    console.error('Admin posts error:', e);
                }

                // التواريخ
                try {
                    const datesCollectionRef = collection(db, `artifacts/${appId}/public/data/love_app_dates`);
                    const datesQuery = query(datesCollectionRef, orderBy('date', 'desc'), limit(50));
                    const datesSnap = await getDocs(datesQuery);
                    const datesEl = document.getElementById('admin-dates');
                    datesEl.innerHTML = '';
                    if (datesSnap.empty) {
                        datesEl.textContent = 'لا توجد تواريخ.';
                    }
                    datesSnap.forEach(d => {
                        const v = d.data();
                        const t = v.date && v.date.toDate ? v.date.toDate().toLocaleDateString('ar-EG') : '...';
                        const row = document.createElement('div');
                        row.className = 'flex items-center justify-between border-b border-gray-100 py-1';
                        row.innerHTML = `<span>${v.title} · ${t} · ${getDisplayName(v.created_by || '')}</span><button class="admin-delete-date px-2 py-1 bg-red-600 text-white rounded">حذف</button>`;
                        row.querySelector('.admin-delete-date').addEventListener('click', async () => {
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/love_app_dates`, d.id));
                            row.remove();
                        });
                        datesEl.appendChild(row);
                    });
                    const df = document.getElementById('filter-dates');
                    if (df) df.addEventListener('input', () => {
                        const q = df.value.trim();
                        [...datesEl.children].forEach(c => { c.style.display = c.textContent.includes(q) ? '' : 'none'; });
                    });
                    const refreshBtn = document.getElementById('admin-refresh');
                    if (refreshBtn) refreshBtn.addEventListener('click', () => showView('admin'));
                    const exportBtn = document.getElementById('admin-export-dates');
                    if (exportBtn) exportBtn.addEventListener('click', async () => {
                        const snap = await getDocs(datesCollectionRef);
                        const rows = ['title,date,created_by'];
                        snap.forEach(dd => {
                            const vv = dd.data();
                            const dt = vv.date && vv.date.toDate ? vv.date.toDate().toISOString().split('T')[0] : '';
                            rows.push(`${(vv.title||'').replace(/,/g,' ')},${dt},${vv.created_by||''}`);
                        });
                        const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'dates.csv';
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        URL.revokeObjectURL(url);
                    });
                } catch (e) {
                    const datesEl = document.getElementById('admin-dates');
                    datesEl.textContent = 'فشل تحميل التواريخ.';
                    console.error('Admin dates error:', e);
                }

                lucide.createIcons();
            })().catch((e) => {
                try {
                    const statsEl = document.getElementById('admin-stats');
                    const presenceEl = document.getElementById('presence-status');
                    const auditListEl = document.getElementById('audit-list');
                    const msgEl = document.getElementById('admin-messages');
                    const postEl = document.getElementById('admin-posts');
                    const datesEl = document.getElementById('admin-dates');
                    if (statsEl) statsEl.textContent = 'فشل تحميل الإحصائيات.';
                    if (presenceEl) presenceEl.textContent = 'تعذر تحميل الحالة';
                    if (auditListEl) auditListEl.textContent = 'تعذر تحميل سجل النشاط.';
                    if (msgEl) msgEl.textContent = 'فشل تحميل الرسائل.';
                    if (postEl) postEl.textContent = 'فشل تحميل المناشير.';
                    if (datesEl) datesEl.textContent = 'فشل تحميل التواريخ.';
                    console.error('Admin view error:', e);
                } catch(_) {}
            });
        }

        // --- معالجات بيانات Firestore في الوقت الفعلي ---
        
        // متغيرات لتخزين وظائف إلغاء الاشتراك لتجنب تكرار المستمعين
        let unsubscribeChat = () => {};
        let unsubscribePosts = () => {};

        function loadRealtimeData() {
            // تأكد من تهيئة Firebase واسم المستخدم ومعرف المستخدم
            if (!db || !currentAppUser || !currentUserId) {
                console.log("Database or User Auth not ready. Skipping data load.");
                return;
            }
            
            // إلغاء الاشتراك من المستمعات القديمة لمنع التكرار
            unsubscribeChat();
            unsubscribePosts();

            // 1. مستمع الدردشة
            const chatCollectionRef = collection(db, `artifacts/${appId}/public/data/love_app_chats`);
            const chatQuery = query(chatCollectionRef, orderBy("timestamp", "asc"));
            
            // نتحقق من وجود الحاوية أولاً قبل ربط المستمع
            if (document.getElementById('messages-container')) {
                unsubscribeChat = onSnapshot(chatQuery, (snapshot) => {
                    const messagesContainer = document.getElementById('messages-container');
                    if (!messagesContainer) return; // قد يكون المستخدم انتقل لصفحة أخرى
                    
                    // حفظ موضع التمرير الحالي
                    const isAtBottom = messagesContainer.scrollHeight - messagesContainer.clientHeight <= messagesContainer.scrollTop + 1;
                    
                    messagesContainer.innerHTML = ''; // مسح الرسائل الموجودة
                    
                    snapshot.forEach(doc => {
                        const messageData = doc.data();
                        const isMine = messageData.user === currentAppUser.id;
                        // تعيين الفئات بناءً على المرسل
                        const messageClass = isMine ? 'chat-message-maha' : 'chat-message-jehad'; 
                        const senderName = getDisplayName(messageData.user);
                        const avatarClass = messageData.user === 'Maha' ? 'avatar-Maha' : 'avatar-Jehad';
                        
                        const messageHtml = `
                            <!-- الرسالة: تظهر على اليمين إذا كانت للمستخدم الحالي، وعلى اليسار لغيره -->
                            <div class="flex ${isMine ? 'justify-end' : 'justify-start'}">
                                ${!isMine ? renderAvatar(messageData.user, 'w-8 h-8 text-sm', 'mr-2') : ''}
                                <div class="max-w-xs md:max-w-md p-3 rounded-2xl ${messageClass} shadow-lg">
                                    <p class="text-xs font-extrabold mb-1 ${isMine ? 'text-violet-800' : 'text-indigo-800'}">${senderName}</p>
                                    <p class="text-sm text-gray-800">${messageData.message}</p>
                                    <!-- الوقت يظهر في الزاوية اليسرى للرسالة -->
                                    <p class="text-left text-[10px] text-gray-600 mt-1">${formatTimestamp(messageData.timestamp)}</p>
                                </div>
                                ${isMine ? renderAvatar(messageData.user, 'w-8 h-8 text-sm', 'ml-2') : ''}
                            </div>
                        `;
                        messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                    });
                    
                    // التمرير إلى أسفل حاوية الرسائل فقط إذا كنا بالفعل في الأسفل أو إذا كانت رسالة جديدة
                    if (isAtBottom || snapshot.docChanges().some(change => change.type === 'added')) {
                         messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }

                });
            }


            // 2. مستمع المناشير
            const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/love_app_posts`);
            const postsQuery = query(postsCollectionRef, orderBy("date", "desc"));
            
            // نتحقق من وجود الحاوية أولاً قبل ربط المستمع
            if (document.getElementById('posts-list')) {
                unsubscribePosts = onSnapshot(postsQuery, (snapshot) => {
                    const postsList = document.getElementById('posts-list');
                    if (!postsList) return; // قد يكون المستخدم انتقل لصفحة أخرى

                    postsList.innerHTML = ''; // مسح المناشير الموجودة
                    
                    if (snapshot.empty) {
                        postsList.innerHTML = '<div class="text-center text-gray-400 mt-4">لا توجد مناشير بعد.</div>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const postData = doc.data();
                        const senderName = getDisplayName(postData.user);
                        const avatarClass = postData.user === 'Maha' ? 'avatar-Maha' : 'avatar-Jehad';
                        const bgColor = postData.user === 'Maha' ? 'bg-pink-50' : 'bg-indigo-50';
                        const borderSideColor = postData.user === 'Maha' ? 'border-pink-500' : 'border-indigo-500';
                        
                        const postHtml = `
                            <div class="${bgColor} p-4 rounded-xl shadow-lg border-r-4 ${borderSideColor} transform hover:scale-[1.01] transition duration-300">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center">
                                        <!-- الأفاتار الخاص بالمنشورات -->
                                        ${renderAvatar(postData.user, 'w-8 h-8 text-sm', 'mr-3')}
                                        <span class="font-extrabold text-lg ${postData.user === 'Maha' ? 'text-pink-600' : 'text-indigo-600'}">${senderName}</span>
                                    </div>
                                    <span class="text-xs text-gray-500 flex items-center">
                                        <i data-lucide="clock" class="w-3 h-3 ml-1"></i> 
                                        ${formatTimestamp(postData.date)}
                                    </span>
                                </div>
                                <p class="text-gray-700 mt-2 pr-10">${postData.content}</p>
                                <div class="flex items-center gap-3 mt-3">
                                    <button class="px-2 py-1 bg-pink-500 hover:bg-pink-600 text-white rounded" onclick="likePost('${doc.id}')"><i data-lucide="heart" class="w-4 h-4 ml-1"></i> ${postData.likes || 0}</button>
                                    <button class="px-2 py-1 bg-indigo-500 hover:bg-indigo-600 text-white rounded" onclick="toggleComments('${doc.id}')"><i data-lucide="message-square" class="w-4 h-4 ml-1"></i> التعليقات</button>
                                </div>
                                <div class="mt-2">
                                    <div class="flex items-center gap-2">
                                        <input id="comment-input-${doc.id}" type="text" placeholder="اكتب تعليق..." class="flex-grow p-2 border rounded-xl">
                                        <button class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded" onclick="addComment('${doc.id}')">تعليق</button>
                                    </div>
                                    <div id="comments-box-${doc.id}" class="mt-2 space-y-1"></div>
                                </div>
                            </div>
                        `;
                        postsList.insertAdjacentHTML('beforeend', postHtml);
                    });
                    lucide.createIcons(); // إعادة عرض الأيقونات بعد تحميل المناشير
                });
            }
        }

        // إرسال رسالة الدردشة إلى Firestore
        async function sendChatMessage() {
            // *** تأكيد أن الزر يعمل ***
            console.log("Send button clicked. Attempting to send message...");

            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();

            if (message && db && currentAppUser) {
                try {
                    const chatCollectionRef = collection(db, `artifacts/${appId}/public/data/love_app_chats`);
                    await addDoc(chatCollectionRef, {
                        user: currentAppUser.id, // 'Maha' or 'Jehad'
                        message: message,
                        timestamp: serverTimestamp()
                    });
                    chatInput.value = ''; // مسح الإدخال
                    console.log("Message sent successfully to Firestore.");
                } catch (e) {
                    console.error("Error adding chat message (Firebase error):", e);
                }
            } else if (!message) {
                 console.warn("Cannot send empty message.");
            } else {
                 console.error("Firebase DB or User not ready for chat operation.");
            }
        }

        // إضافة منشور جديد إلى Firestore
        async function addPost() {
             // *** تأكيد أن الزر يعمل ***
            console.log("Add Post button clicked. Attempting to publish...");

            const postInput = document.getElementById('post-input');
            const content = postInput.value.trim();

            if (content && db && currentAppUser) {
                try {
                    const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/love_app_posts`);
                    await addDoc(postsCollectionRef, {
                        user: currentAppUser.id, // 'Maha' or 'Jehad'
                        content: content,
                        date: serverTimestamp()
                    });
                    postInput.value = ''; // مسح الإدخال
                    console.log("Post published successfully to Firestore.");
                } catch (e) {
                    console.error("Error adding post (Firebase error):", e);
                }
            } else if (!content) {
                console.warn("Cannot publish empty post.");
            } else {
                console.error("Firebase DB or User not ready for post operation.");
            }
        }

        // --- وظائف مساعدة ---

        // تنسيق الطابع الزمني (Timestamp)
        function formatTimestamp(timestamp) {
            if (!timestamp) return '...';
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else {
                date = new Date(); // قيمة احتياطية لانتظار الـ serverTimestamp
            }
            // تنسيق بسيط للوقت (ساعة:دقيقة)
            return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
        }

        let deferredPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });
        (async () => {
            try {
                if ('serviceWorker' in navigator) {
                    await navigator.serviceWorker.register('./sw.js');
                }
            } catch(e) {}
        })();

        window.likePost = async (postId) => {
            const ref = doc(db, `artifacts/${appId}/public/data/love_app_posts`, postId);
            await setDoc(ref, { likes: increment(1) }, { merge: true });
        };
        window.addComment = async (postId) => {
            const input = document.getElementById(`comment-input-${postId}`);
            const text = (input?.value || '').trim();
            if (!text) return;
            const commentsRef = collection(db, `artifacts/${appId}/public/data/love_app_posts/${postId}/comments`);
            await addDoc(commentsRef, { user: currentAppUser?.id || 'Unknown', text, date: serverTimestamp() });
            input.value = '';
            await window.toggleComments(postId);
        };
        window.toggleComments = async (postId) => {
            const box = document.getElementById(`comments-box-${postId}`);
            if (!box) return;
            box.innerHTML = '<div class="text-gray-400 text-xs">جاري التحميل...</div>';
            const commentsRef = collection(db, `artifacts/${appId}/public/data/love_app_posts/${postId}/comments`);
            const snap = await getDocs(commentsRef);
            box.innerHTML = '';
            snap.forEach((c) => {
                const v = c.data();
                const name = getDisplayName(v.user);
                const time = v.date && v.date.toDate ? v.date.toDate().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '...';
                box.insertAdjacentHTML('beforeend', `<div class="text-xs text-gray-700 border-b border-gray-100 py-1"><span class="font-bold ${v.user === 'Maha' ? 'text-pink-600' : 'text-indigo-600'}">${name}</span>: ${v.text} <span class="text-gray-400">· ${time}</span></div>`);
            });
        };


        // --- نقطة دخول التطبيق ---
        initializeFirebase();
        lucide.createIcons(); // تهيئة جميع الأيقونات عند تحميل الصفحة

    </script>
</body>
</html>